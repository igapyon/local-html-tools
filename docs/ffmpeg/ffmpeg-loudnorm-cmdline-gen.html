<!--
Copyright 2025 Toshiki Iga

Licensed under the Apache License, Version 2.0
-->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>FFmpeg Loudnorm スクリプトジェネレータ</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 text-gray-800 p-6">
  <div class="max-w-3xl mx-auto bg-white shadow-md rounded-lg p-6">
    <h1 class="text-2xl font-bold mb-6">FFmpeg Loudnorm スクリプトジェネレータ (v20250815b)</h1>

    <!-- 1. 測定フェーズ -->
    <h2 class="text-xl font-semibold mt-4 mb-2">1. 測定フェーズコマンド</h2>
    <label for="filename" class="block mb-1">音声ファイル名（例: 250503_130527_TrMic.WAV）:</label>
    <input type="text" id="filename" placeholder="例: 250503_130527_TrMic.WAV" class="border border-gray-300 rounded w-full p-2 mb-3">
    <button onclick="generateAnalyzeCmd()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded mb-3">測定用コマンド生成</button>
    <div class="relative mb-4">
      <code id="analyzeCmd" class="bg-gray-100 p-3 block rounded overflow-x-auto pr-10"></code>
      <button class="absolute top-2 right-2 bg-gray-200 px-2 py-1 rounded text-sm hover:bg-gray-300" onclick="copyToClipboard('analyzeCmd')">📋</button>
    </div>

    <!-- 2. 音質設定 -->
    <h2 class="text-xl font-semibold mt-6 mb-2">2. 音質設定</h2>
    <div class="mb-4">
      <!-- ハイレゾ選択 -->
      <label class="inline-flex items-center mr-6">
        <input type="checkbox" id="hires" class="mr-2">
        ハイレゾ（192kHz / 24bit）
      </label>
    </div>
    <div class="mb-4 space-y-3">
      <!-- モード切り替え -->
      <div class="flex items-start gap-2">
        <label class="inline-flex items-center">
          <input type="radio" name="mode" value="music_release" class="mr-2" checked>
          <span>音楽（配信用）</span>
        </label>
        <button type="button" class="text-blue-600 hover:text-blue-800" aria-expanded="false" data-target="mode-info-music-release">ℹ️</button>
      </div>
      <div id="mode-info-music-release" class="ml-7 text-sm text-gray-600 hidden bg-gray-100 rounded p-2">配信や販売を意識した仕上げ用。ストリーミング基準の音圧で、安心できるピーク管理と適度なダイナミクスを両立します。</div>

      <div class="flex items-start gap-2">
        <label class="inline-flex items-center">
          <input type="radio" name="mode" value="music_practice" class="mr-2">
          <span>音楽（練習用）</span>
        </label>
        <button type="button" class="text-blue-600 hover:text-blue-800" aria-expanded="false" data-target="mode-info-music-practice">ℹ️</button>
      </div>
      <div id="mode-info-music-practice" class="ml-7 text-sm text-gray-600 hidden bg-gray-100 rounded p-2">オーケストラや吹奏楽の練習録音向け。ダイナミクスを最大限に残しつつ、バランス確認しやすい音量に整えます。</div>

      <div class="flex items-start gap-2">
        <label class="inline-flex items-center">
          <input type="radio" name="mode" value="strong" class="mr-2">
          <span>音楽＋指揮者モード</span>
        </label>
        <button type="button" class="text-blue-600 hover:text-blue-800" aria-expanded="false" data-target="mode-info-strong">ℹ️</button>
      </div>
      <div id="mode-info-strong" class="ml-7 text-sm text-gray-600 hidden bg-gray-100 rounded p-2">指揮者のコメントを聞き取りやすくしつつ、演奏の強弱も適度に残したい場合に最適です。</div>

      <div class="flex items-start gap-2">
        <label class="inline-flex items-center">
          <input type="radio" name="mode" value="cinema" class="mr-2">
          <span>映画 / ドラマ</span>
        </label>
        <button type="button" class="text-blue-600 hover:text-blue-800" aria-expanded="false" data-target="mode-info-cinema">ℹ️</button>
      </div>
      <div id="mode-info-cinema" class="ml-7 text-sm text-gray-600 hidden bg-gray-100 rounded p-2">映画やドラマのミックスチェック向け。広いラウドネスレンジでセリフと効果音のメリハリを確保します。</div>

      <div class="flex items-start gap-2">
        <label class="inline-flex items-center">
          <input type="radio" name="mode" value="variety" class="mr-2">
          <span>バラエティ</span>
        </label>
        <button type="button" class="text-blue-600 hover:text-blue-800" aria-expanded="false" data-target="mode-info-variety">ℹ️</button>
      </div>
      <div id="mode-info-variety" class="ml-7 text-sm text-gray-600 hidden bg-gray-100 rounded p-2">トーク中心のテレビ番組を想定し、声を前に出しながらも BGM や効果音とのバランスを取りやすくします。</div>

      <div class="flex items-start gap-2">
        <label class="inline-flex items-center">
          <input type="radio" name="mode" value="podcast" class="mr-2">
          <span>ポッドキャスト / トーク</span>
        </label>
        <button type="button" class="text-blue-600 hover:text-blue-800" aria-expanded="false" data-target="mode-info-podcast">ℹ️</button>
      </div>
      <div id="mode-info-podcast" class="ml-7 text-sm text-gray-600 hidden bg-gray-100 rounded p-2">トーク番組やポッドキャスト向け。複数の話者でも聞きやすいよう中程度のラウドネスに揃えます。</div>

      <div class="flex items-start gap-2">
        <label class="inline-flex items-center">
          <input type="radio" name="mode" value="livestream" class="mr-2">
          <span>ライブ配信</span>
        </label>
        <button type="button" class="text-blue-600 hover:text-blue-800" aria-expanded="false" data-target="mode-info-livestream">ℹ️</button>
      </div>
      <div id="mode-info-livestream" class="ml-7 text-sm text-gray-600 hidden bg-gray-100 rounded p-2">ゲーム実況やライブ配信向け。声・BGM・効果音のピークを抑えつつ、配信基準に合わせます。</div>

      <div class="flex items-start gap-2">
        <label class="inline-flex items-center">
          <input type="radio" name="mode" value="lecture" class="mr-2">
          <span>講演 / セミナー</span>
        </label>
        <button type="button" class="text-blue-600 hover:text-blue-800" aria-expanded="false" data-target="mode-info-lecture">ℹ️</button>
      </div>
      <div id="mode-info-lecture" class="ml-7 text-sm text-gray-600 hidden bg-gray-100 rounded p-2">講演や質疑応答の収録向け。話者の声量差を吸収しながら聞き取りやすさを重視します。</div>

      <div class="flex items-start gap-2">
        <label class="inline-flex items-center">
          <input type="radio" name="mode" value="bgm" class="mr-2">
          <span>BGM / Lo-Fi</span>
        </label>
        <button type="button" class="text-blue-600 hover:text-blue-800" aria-expanded="false" data-target="mode-info-bgm">ℹ️</button>
      </div>
      <div id="mode-info-bgm" class="ml-7 text-sm text-gray-600 hidden bg-gray-100 rounded p-2">常時再生するバックグラウンドミュージック向け。耳障りになりにくいよう穏やかなダイナミクスにまとめます。</div>

      <div class="flex items-start gap-2">
        <label class="inline-flex items-center">
          <input type="radio" name="mode" value="asmr" class="mr-2">
          <span>ASMR / 朗読</span>
        </label>
        <button type="button" class="text-blue-600 hover:text-blue-800" aria-expanded="false" data-target="mode-info-asmr">ℹ️</button>
      </div>
      <div id="mode-info-asmr" class="ml-7 text-sm text-gray-600 hidden bg-gray-100 rounded p-2">近接収録の繊細な音向け。低ノイズで細かなニュアンスを保ちながら自然な音量感に整えます。</div>
    </div>

    <!-- 3. 正規化フェーズ -->
    <h2 class="text-xl font-semibold mt-6 mb-2">3. 実際の正規化コマンド</h2>
    <label for="jsonInput" class="block mb-1">ラウドネス測定結果（ffmpeg出力全文）:</label>
    <textarea id="jsonInput" rows="10" placeholder='ffmpeg の出力全文を貼り付けてください' class="border border-gray-300 rounded w-full p-2 mb-3"></textarea>
    <button onclick="generateNormalizeCmd()" class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded mb-3">正規化コマンド生成</button>
    <div class="relative">
      <code id="normalizeCmd" class="bg-gray-100 p-3 block rounded overflow-x-auto pr-10"></code>
      <button class="absolute top-2 right-2 bg-gray-200 px-2 py-1 rounded text-sm hover:bg-gray-300" onclick="copyToClipboard('normalizeCmd')">📋</button>
    </div>

    <!-- 4. 単純ゲインフェーズ -->
    <h2 class="text-xl font-semibold mt-6 mb-2">4. 解析結果から単純ゲイン</h2>
    <p class="text-sm text-gray-600 mb-2">測定結果の input_i と選択モードの I の差分を dB で計算し、volume=+XdB を生成します。</p>
    <button onclick="generateGainCmd()" class="bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-4 rounded mb-3">単純ゲインコマンド生成</button>
    <div class="relative">
      <code id="gainCmd" class="bg-gray-100 p-3 block rounded overflow-x-auto pr-10"></code>
      <button class="absolute top-2 right-2 bg-gray-200 px-2 py-1 rounded text-sm hover:bg-gray-300" onclick="copyToClipboard('gainCmd')">📋</button>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-4 py-2 rounded shadow-lg opacity-0 transition-opacity duration-300 pointer-events-none">コピーしました</div>

  <script>
    function generateAnalyzeCmd() {
      const filename = document.getElementById("filename").value.trim();
      if (!filename) return alert("ファイル名を入力してください。");
      const outFile = filename.replace(/\.WAV$/i, "-loudnorm-meta.json");
      const cmd = `ffmpeg -i ${filename} -af loudnorm=print_format=json -f null - 2>&1 | tee ${outFile}`;
      document.getElementById("analyzeCmd").textContent = cmd;
    }

    function extractJson(text) {
      const start = text.indexOf('{');
      const end = text.lastIndexOf('}');
      if (start === -1 || end === -1 || end <= start) throw new Error("JSON部分が見つかりません");
      return text.substring(start, end + 1);
    }

    function getModeConfig() {
      const modeConfigs = {
        music_release: { I: -14, LRA: 11, tp: -1.0, linear: "true", tag: "music-release" },
        music_practice:{ I: -21, LRA: 20, tp: -1.5, linear: "true", tag: "music-practice" },
        strong:        { I: -17, LRA: 10, tp: -1.5, linear: "true", tag: "strong" },
        cinema:        { I: -23, LRA: 22, tp: -1.0, linear: "true", tag: "cinema" },
        variety:       { I: -16, LRA: 8,  tp: -1.0, linear: "true", tag: "variety" },
        podcast:       { I: -18, LRA: 7,  tp: -1.0, linear: "true", tag: "podcast" },
        livestream:    { I: -16, LRA: 6,  tp: -1.0, linear: "true", tag: "livestream" },
        lecture:       { I: -18, LRA: 9,  tp: -1.0, linear: "true", tag: "lecture" },
        bgm:           { I: -16, LRA: 5,  tp: -1.0, linear: "true", tag: "bgm" },
        asmr:          { I: -20, LRA: 12, tp: -1.5, linear: "true", tag: "asmr" }
      };
      const modeValue = document.querySelector('input[name="mode"]:checked').value;
      return modeConfigs[modeValue] || modeConfigs.music_release;
    }

    function getRezConfig() {
      const hires = document.getElementById("hires").checked;
      if (hires) {
        return { ar: 192000, sample_fmt: "s32", codec: "pcm_s24le", rezTag: "hires" };
      }
      return { ar: 44100, sample_fmt: "s16", codec: "pcm_s16le", rezTag: "lores" };
    }

    function generateNormalizeCmd() {
      try {
        const raw = document.getElementById("jsonInput").value;
        const extracted = extractJson(raw);
        const json = JSON.parse(extracted);

        const filenameInput = document.getElementById("filename");
        let inputFile = filenameInput.value.trim();

        if (!inputFile) {
          const match = raw.match(/from '([^']+\.(wav|WAV|flac|aiff))'/);
          if (match) {
            inputFile = match[1];
            filenameInput.value = inputFile;
          } else {
            alert("ファイル名を入力してください（または ffmpeg 出力に含まれる必要があります）。");
            return;
          }
        }

        // モード設定
        const modeConfig = getModeConfig();
        const { I, LRA, tp, linear, tag: modeTag } = modeConfig;

        // ローレゾ / ハイレゾ設定
        const { ar, sample_fmt, codec, rezTag } = getRezConfig();

        // 出力ファイル名にタグ追加
        const outFile = inputFile.replace(/\.(wav|WAV|flac|aiff)$/i, `-loudnorm-${rezTag}-${modeTag}.wav`);

        const cmd = `ffmpeg -i ${inputFile} \
-af loudnorm=I=${I}:TP=${tp}:LRA=${LRA}:measured_I=${json.input_i}:measured_TP=${json.input_tp}:measured_LRA=${json.input_lra}:measured_thresh=${json.input_thresh}:offset=${json.target_offset}:linear=${linear}:print_format=summary \
-ar ${ar} -sample_fmt ${sample_fmt} -c:a ${codec} \
${outFile}`;

        document.getElementById("normalizeCmd").textContent = cmd;
      } catch (e) {
        alert("正しい JSON を含む ffmpeg 出力を貼り付けてください。\n" + e.message);
      }
    }

    function generateGainCmd() {
      try {
        const raw = document.getElementById("jsonInput").value;
        const extracted = extractJson(raw);
        const json = JSON.parse(extracted);

        const filenameInput = document.getElementById("filename");
        let inputFile = filenameInput.value.trim();

        if (!inputFile) {
          const match = raw.match(/from '([^']+\.(wav|WAV|flac|aiff))'/);
          if (match) {
            inputFile = match[1];
            filenameInput.value = inputFile;
          } else {
            alert("ファイル名を入力してください（または ffmpeg 出力に含まれる必要があります）。");
            return;
          }
        }

        const modeConfig = getModeConfig();
        const targetI = modeConfig.I;
        const inputI = Number(json.input_i);
        if (isNaN(inputI)) {
          alert("input_i が解析できません。ffmpeg 出力を確認してください。");
          return;
        }

        const gain = Math.round((targetI - inputI) * 10) / 10;
        const gainLabel = `${gain >= 0 ? "+" : ""}${gain}dB`;

        const { ar, sample_fmt, codec, rezTag } = getRezConfig();
        const modeTag = modeConfig.tag;
        const outFile = inputFile.replace(/\.(wav|WAV|flac|aiff)$/i, `-gain-${rezTag}-${modeTag}-${gainLabel}.wav`);
        const cmd = `ffmpeg -i ${inputFile} -af volume=${gainLabel} -ar ${ar} -sample_fmt ${sample_fmt} -c:a ${codec} ${outFile}`;

        document.getElementById("gainCmd").textContent = cmd;
      } catch (e) {
        alert("正しい JSON を含む ffmpeg 出力を貼り付けてください。\n" + e.message);
      }
    }

    function copyToClipboard(elementId) {
      const el = document.getElementById(elementId);
      const temp = document.createElement("textarea");
      temp.value = el.textContent;
      document.body.appendChild(temp);
      temp.select();
      document.execCommand("copy");
      document.body.removeChild(temp);
      showToast("コピーしました");
    }

    function showToast(message) {
      const toast = document.getElementById("toast");
      toast.textContent = message;
      toast.classList.remove("opacity-0", "pointer-events-none");
      toast.classList.add("opacity-100");
      setTimeout(() => {
        toast.classList.remove("opacity-100");
        toast.classList.add("opacity-0", "pointer-events-none");
      }, 2000);
    }

    document.querySelectorAll('button[data-target^="mode-info-"]').forEach(button => {
      button.addEventListener("click", () => {
        const targetId = button.getAttribute("data-target");
        const target = document.getElementById(targetId);
        if (!target) return;
        const willShow = target.classList.contains("hidden");
        target.classList.toggle("hidden");
        button.setAttribute("aria-expanded", willShow ? "true" : "false");
      });
    });
  </script>
</body>
</html>
