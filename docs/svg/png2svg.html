<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PNG â†’ SVG å¤‰æ› Pro</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #preview svg {
      width: 100%;
      height: 100%;
      display: block;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 p-6">
  <div class="max-w-2xl mx-auto bg-white shadow-md rounded-lg p-6 relative">
    <button type="button" class="absolute top-4 right-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1 px-2 rounded" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼" onclick="toggleMenu()">
      <svg aria-hidden="true" viewBox="0 0 24 24" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
        <path d="M4 6h16"/><path d="M4 12h16"/><path d="M4 18h16"/>
      </svg>
    </button>
    <div id="menuPanel" class="absolute top-12 right-4 bg-white border border-gray-200 rounded shadow-md hidden z-20">
      <a href="../index.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>
    </div>

    <h1 class="text-2xl font-bold mb-6 flex items-center">
      <span aria-hidden="true" class="mr-2">ğŸ–¼ï¸</span>PNG â†’ SVG å¤‰æ› Pro
    </h1>

    <div class="mb-6">
      <label class="flex items-center gap-2 mb-2 font-semibold">
        <span>PNGãƒ•ã‚¡ã‚¤ãƒ«</span>
        <span class="text-red-500 font-bold">*</span>
      </label>
      <input id="file" type="file" accept="image/png" class="border border-gray-300 rounded w-full p-2 bg-gray-50" />
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
      <div>
        <label class="flex items-center gap-2 mb-2 font-semibold">
          <span>ãƒ—ãƒªã‚»ãƒƒãƒˆ</span>
          <span class="relative inline-flex items-center group">
            <span class="inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-gray-600 bg-gray-200 rounded-full cursor-help">?</span>
            <span id="presetDescription" class="absolute left-1/2 bottom-full mb-2 w-64 -translate-x-1/2 rounded bg-gray-900 text-white text-xs px-3 py-2 opacity-0 group-hover:opacity-100 transition pointer-events-none z-10 shadow-xl">
              ç”¨é€”ã«åˆã‚ã›ãŸæœ€é©ãªæ•°å€¤ã‚’ã‚»ãƒƒãƒˆã—ã¾ã™ã€‚
            </span>
          </span>
        </label>
        <select id="preset" class="border border-gray-300 rounded w-full p-2 bg-white cursor-pointer">
          <option value="icon">ã‚¢ã‚¤ã‚³ãƒ³ãƒ»ãƒ­ã‚´ï¼ˆè»½é‡ãƒ»é‹­åˆ©ï¼‰</option>
          <option value="illustration" selected>ã‚¤ãƒ©ã‚¹ãƒˆï¼ˆãªã‚ã‚‰ã‹ãƒ»æ›²ç·šï¼‰</option>
          <option value="photo">å†™çœŸï¼ˆèŠ¸è¡“çš„ãƒ»æ²¹çµµé¢¨ï¼‰</option>
          <option value="pixelart">ãƒ‰ãƒƒãƒˆçµµï¼ˆãƒ”ã‚¯ã‚»ãƒ«å®Œå…¨å†ç¾ï¼‰</option>
        </select>
      </div>

      <div>
        <label class="flex items-center gap-2 mb-2 font-semibold">
          <span>è‰²æ•°</span>
          <span class="relative inline-flex items-center group">
            <span class="inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-gray-600 bg-gray-200 rounded-full cursor-help">?</span>
            <span class="absolute left-1/2 bottom-full mb-2 w-64 -translate-x-1/2 rounded bg-gray-900 text-white text-xs px-3 py-2 opacity-0 group-hover:opacity-100 transition pointer-events-none z-10 shadow-xl">
              ä½¿ç”¨ã™ã‚‹è‰²ã®æ•°ï¼ˆ2ã€œ64ï¼‰ã€‚å¤šã„ã»ã©è©³ç´°ã§ã™ãŒé‡ããªã‚Šã¾ã™ã€‚
            </span>
          </span>
        </label>
        <input id="colors" type="number" min="2" max="64" value="12" class="border border-gray-300 rounded w-full p-2" />
      </div>

      <div>
        <label class="flex items-center gap-2 mb-2 font-semibold">
          <span>è¼ªéƒ­ã®ç²¾åº¦ (ltres)</span>
          <span class="relative inline-flex items-center group">
            <span class="inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-gray-600 bg-gray-200 rounded-full cursor-help">?</span>
            <span class="absolute left-1/2 bottom-full mb-2 w-64 -translate-x-1/2 rounded bg-gray-900 text-white text-xs px-3 py-2 opacity-0 group-hover:opacity-100 transition pointer-events-none z-10 shadow-xl">
              ä½ã„ã»ã©å…ƒã®å½¢ã«å¿ å®Ÿã€é«˜ã„ã»ã©ãƒã‚¤ã‚ºã‚’ç„¡è¦–ã—ã¾ã™ã€‚
            </span>
          </span>
        </label>
        <input id="ltres" type="number" min="0" max="10" step="0.1" value="1.0" class="border border-gray-300 rounded w-full p-2" />
      </div>

      <div>
        <label class="flex items-center gap-2 mb-2 font-semibold">
          <span>æ›²ç·šã®ç²¾åº¦ (qtres)</span>
          <span class="relative inline-flex items-center group">
            <span class="inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-gray-600 bg-gray-200 rounded-full cursor-help">?</span>
            <span class="absolute left-1/2 bottom-full mb-2 w-64 -translate-x-1/2 rounded bg-gray-900 text-white text-xs px-3 py-2 opacity-0 group-hover:opacity-100 transition pointer-events-none z-10 shadow-xl">
              ä½ã„ã»ã©æ»‘ã‚‰ã‹ãªæ›²ç·šã€é«˜ã„ã»ã©ç›´ç·šçš„ãªæç”»ã«ãªã‚Šã¾ã™ã€‚
            </span>
          </span>
        </label>
        <input id="qtres" type="number" min="0.1" max="10" step="0.1" value="0.1" class="border border-gray-300 rounded w-full p-2" />
      </div>
    </div>

    <div class="flex gap-3 mb-8">
      <button id="convert" disabled class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded shadow-sm disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
        SVGã«å¤‰æ›ã™ã‚‹
      </button>
    </div>

    <div class="mb-2 font-semibold flex items-center justify-between">
      <span>ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</span>
      <span id="fileInfo" class="text-xs text-gray-500 font-normal"></span>
    </div>
    <div id="preview" class="border-2 border-dashed border-gray-200 rounded bg-gray-50 h-80 flex items-center justify-center overflow-hidden transition-all">
      <p class="text-gray-400 text-sm">ã“ã“ã«å¤‰æ›å¾Œã®ç”»åƒãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
    </div>

    <div class="flex gap-3 mt-6">
      <button id="download" disabled class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded shadow-sm disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors">
        SVGã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      </button>
    </div>
  </div>

  <div id="loading" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm">
    <div class="bg-white px-8 py-6 rounded-xl shadow-2xl flex flex-col items-center">
      <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-blue-600 mb-4"></div>
      <p class="font-bold text-gray-700">ãƒ™ã‚¯ã‚¿ãƒ¼å¤‰æ›ä¸­...</p>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/imagetracerjs@1.2.6/imagetracer_v1.2.6.js"></script>

  <script>
    const fileInput = document.getElementById("file");
    const convertBtn = document.getElementById("convert");
    const downloadBtn = document.getElementById("download");
    const preview = document.getElementById("preview");
    const loading = document.getElementById("loading");
    const colorsInput = document.getElementById("colors");
    const ltresInput = document.getElementById("ltres");
    const qtresInput = document.getElementById("qtres");
    const presetSelect = document.getElementById("preset");
    const presetDesc = document.getElementById("presetDescription");

    let selectedFile = null;
    let lastSvgText = "";

    // Geminiç©¶æ¥µã®ãƒ—ãƒªã‚»ãƒƒãƒˆå®šç¾©
    const presetMap = {
      icon: { 
        numberofcolors: 4, ltres: 0.1, qtres: 5.0, 
        desc: "ãƒ­ã‚´ã‚„ã‚¢ã‚¤ã‚³ãƒ³ç”¨ã€‚è¼ªéƒ­ã‚’æ¥µé™ã¾ã§é‹­ãä¿ã¡ã€ãƒ‘ã‚¹ã®æ•°ã‚’æ¸›ã‚‰ã—ã¦ãƒ‡ãƒ¼ã‚¿é‡ã‚’æœ€å°é™ã«ã—ã¾ã™ã€‚" 
      },
      illustration: { 
        numberofcolors: 12, ltres: 1.0, qtres: 0.1, 
        desc: "æ‰‹æ›¸ãã‚¤ãƒ©ã‚¹ãƒˆã‚„æ¼«ç”»ç”¨ã€‚ç·šã®ã‚¬ã‚¿ã¤ãã‚’æŠ‘ãˆã€ç¾ã—ã„ãƒ™ã‚¸ã‚§æ›²ç·šã§æ»‘ã‚‰ã‹ã«è¡¨ç¾ã—ã¾ã™ã€‚" 
      },
      photo: { 
        numberofcolors: 32, ltres: 1.0, qtres: 1.0, 
        desc: "å†™çœŸã‚„è¤‡é›‘ãªçµµç”»ç”¨ã€‚å¤šã‚ã®è‰²æ•°ã§ãƒˆãƒ¬ãƒ¼ã‚¹ã—ã€ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒ†ã‚£ãƒƒã‚¯ãªéšèª¿ã‚’ç”Ÿã¿å‡ºã—ã¾ã™ã€‚" 
      },
      pixelart: { 
        numberofcolors: 16, ltres: 0.0, qtres: 10.0, 
        desc: "ãƒ‰ãƒƒãƒˆçµµå°‚ç”¨ã€‚1ãƒ”ã‚¯ã‚»ãƒ«ã‚‚å´©ã•ãšã€å…ƒã®ãƒã‚¹ç›®ã‚’æ­£ç¢ºãªå››è§’å½¢ã¨ã—ã¦ãƒ™ã‚¯ã‚¿ãƒ¼åŒ–ã—ã¾ã™ã€‚" 
      }
    };

    // ãƒ—ãƒªã‚»ãƒƒãƒˆé©ç”¨é–¢æ•°ï¼ˆèª¬æ˜æ–‡ã‚‚å‹•çš„ã«æ›´æ–°ï¼‰
    function applyPreset(key) {
      const preset = presetMap[key] || presetMap.illustration;
      colorsInput.value = preset.numberofcolors;
      ltresInput.value = preset.ltres;
      qtresInput.value = preset.qtres;
      if (presetDesc) presetDesc.textContent = preset.desc;
    }

    // åˆæœŸåŒ–
    applyPreset(presetSelect.value);

    presetSelect.addEventListener("change", () => applyPreset(presetSelect.value));

    fileInput.addEventListener("change", () => {
      selectedFile = fileInput.files && fileInput.files[0];
      convertBtn.disabled = !selectedFile;
      downloadBtn.disabled = true;
      lastSvgText = "";
      preview.innerHTML = '<p class="text-gray-400 text-sm">ã€Œå¤‰æ›ã™ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>';
      document.getElementById("fileInfo").textContent = selectedFile ? `${selectedFile.name}` : "";
    });

    convertBtn.addEventListener("click", async () => {
      if (!selectedFile) return;

      showLoading(true);
      downloadBtn.disabled = true;
      convertBtn.disabled = true;

      try {
        await nextFrame();

        if (!window.ImageTracer) throw new Error("ImageTracer not loaded.");

        const img = await fileToImage(selectedFile);
        const canvas = document.createElement("canvas");
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        const ctx = canvas.getContext("2d", { willReadFrequently: true });
        ctx.drawImage(img, 0, 0);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const options = readOptions();
        
        // å¤‰æ›å®Ÿè¡Œ
        lastSvgText = window.ImageTracer.imagedataToSVG(imageData, options);

        preview.innerHTML = preparePreviewSvg(lastSvgText);
        downloadBtn.disabled = false;
      } catch (e) {
        console.error(e);
        alert("å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
      } finally {
        showLoading(false);
        convertBtn.disabled = !selectedFile;
      }
    });

    downloadBtn.addEventListener("click", () => {
      if (!lastSvgText) return;
      downloadText(lastSvgText, "converted_vector.svg", "image/svg+xml");
    });

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
    function showLoading(on) {
      loading.classList.toggle("hidden", !on);
      loading.classList.toggle("flex", on);
    }

    function nextFrame() { return new Promise(requestAnimationFrame); }

    function fileToImage(file) {
      return new Promise((resolve, reject) => {
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => { URL.revokeObjectURL(url); resolve(img); };
        img.onerror = reject;
        img.src = url;
      });
    }

    function downloadText(text, filename, mime) {
      const blob = new Blob([text], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function readOptions() {
      return {
        numberofcolors: readNumber(colorsInput, 12, 2, 64),
        ltres: readNumber(ltresInput, 1, 0, 10),
        qtres: readNumber(qtresInput, 1, 0.1, 10),
      };
    }

    function readNumber(input, fallback, min, max) {
      const value = parseFloat(input.value);
      if (isNaN(value)) return fallback;
      return Math.min(Math.max(value, min), max);
    }

    function preparePreviewSvg(svgText) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(svgText, "image/svg+xml");
      const svg = doc.querySelector("svg");
      if (!svg) return svgText;

      const w = svg.getAttribute("width");
      const h = svg.getAttribute("height");
      if (!svg.hasAttribute("viewBox") && w && h) {
        svg.setAttribute("viewBox", `0 0 ${w} ${h}`);
      }
      svg.setAttribute("width", "100%");
      svg.setAttribute("height", "100%");
      svg.setAttribute("preserveAspectRatio", "xMidYMid meet");

      return new XMLSerializer().serializeToString(svg);
    }

    function toggleMenu() {
      const panel = document.getElementById("menuPanel");
      if (panel) panel.classList.toggle("hidden");
    }
  </script>
</body>
</html>