<!--
Copyright 2026 Toshiki Iga

Licensed under the Apache License, Version 2.0 (the "License");
you may not use this file except in compliance with the License.
You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing, software
distributed under the License is distributed on an "AS IS" BASIS,
WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
See the License for the specific language governing permissions and
limitations under the License.
-->
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PNG â†’ SVG å¤‰æ›</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    #preview svg {
      width: 100%;
      height: 100%;
      display: block;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 p-6">
  <div class="max-w-2xl mx-auto bg-white shadow-md rounded-lg p-6 relative">
    <button type="button" class="absolute top-4 right-4 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-1 px-2 rounded" aria-label="ãƒ¡ãƒ‹ãƒ¥ãƒ¼" onclick="toggleMenu()">
      <svg aria-hidden="true" viewBox="0 0 24 24" class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
        <path d="M4 6h16"/>
        <path d="M4 12h16"/>
        <path d="M4 18h16"/>
      </svg>
    </button>
    <div id="menuPanel" class="absolute top-12 right-4 bg-white border border-gray-200 rounded shadow-md hidden">
      <a href="../index.html" class="block px-4 py-2 text-gray-700 hover:bg-gray-100">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>
    </div>

    <h1 class="text-2xl font-bold mb-6"><span aria-hidden="true" class="mr-2">ğŸ–¼ï¸</span>PNG â†’ SVG å¤‰æ›</h1>

    <label class="flex flex-wrap items-center gap-2 mb-2 font-semibold">
      <span>PNGãƒ•ã‚¡ã‚¤ãƒ«</span>
      <span class="text-red-500 font-bold" aria-hidden="true">*</span><span class="sr-only">å¿…é ˆ</span>
      <span class="relative inline-flex items-center group">
        <span class="inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-gray-600 bg-gray-200 rounded-full">?</span>
        <span class="absolute left-1/2 top-full mt-2 w-80 -translate-x-1/2 rounded bg-gray-900 text-white text-xs px-3 py-2 opacity-0 group-hover:opacity-100 transition pointer-events-none">
          PNGç”»åƒã‚’SVGã«ãƒˆãƒ¬ãƒ¼ã‚¹å¤‰æ›ã—ã¾ã™ã€‚å‡¦ç†ã¯ãƒ–ãƒ©ã‚¦ã‚¶å†…ã§è¡Œã‚ã‚Œã€å®Œäº†å¾Œã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚
        </span>
      </span>
      <span>ï¼š</span>
    </label>
    <input id="file" type="file" accept="image/png" class="border border-gray-300 rounded w-full p-2 mb-4" />

    <div class="grid grid-cols-1 sm:grid-cols-4 gap-4 mb-6">
      <div>
        <label class="flex flex-wrap items-center gap-2 mb-2 font-semibold">
          <span>ãƒ—ãƒªã‚»ãƒƒãƒˆ</span>
          <span class="relative inline-flex items-center group">
            <span class="inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-gray-600 bg-gray-200 rounded-full">?</span>
            <span class="absolute left-1/2 top-full mt-2 w-72 -translate-x-1/2 rounded bg-gray-900 text-white text-xs px-3 py-2 opacity-0 group-hover:opacity-100 transition pointer-events-none">
              ç›®çš„ã«åˆã‚ã›ãŸè¨­å®šã‚’é¸ã¶ã¨ã€å€¤ãŒè‡ªå‹•ã§å…¥ã‚Šã¾ã™ã€‚
            </span>
          </span>
        </label>
        <select id="preset" class="border border-gray-300 rounded w-full p-2 bg-white">
          <option value="standard">æ¨™æº–</option>
          <option value="crisp">ãã£ãã‚Šï¼ˆç·šé‡è¦–ï¼‰</option>
          <option value="smooth">ãªã‚ã‚‰ã‹ï¼ˆæ›²ç·šé‡è¦–ï¼‰</option>
          <option value="detail">ç´°éƒ¨é‡è¦–ï¼ˆè‰²æ•°å¤šã‚ï¼‰</option>
        </select>
      </div>
      <div>
        <label class="flex flex-wrap items-center gap-2 mb-2 font-semibold">
          <span>è‰²æ•°</span>
          <span class="relative inline-flex items-center group">
            <span class="inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-gray-600 bg-gray-200 rounded-full">?</span>
            <span class="absolute left-1/2 top-full mt-2 w-72 -translate-x-1/2 rounded bg-gray-900 text-white text-xs px-3 py-2 opacity-0 group-hover:opacity-100 transition pointer-events-none">
              ãƒˆãƒ¬ãƒ¼ã‚¹ã§ä½¿ã†è‰²æ•°ã€‚å°‘ãªã„ã»ã©å˜ç´”ã«ãªã‚Šã€å¢—ã‚„ã™ã¨ç´°éƒ¨ãŒæ®‹ã‚Šã¾ã™ã€‚
            </span>
          </span>
        </label>
        <input id="colors" type="number" min="2" max="64" value="8" class="border border-gray-300 rounded w-full p-2" />
      </div>
      <div>
        <label class="flex flex-wrap items-center gap-2 mb-2 font-semibold">
          <span>è¼ªéƒ­ã®ç²¾åº¦</span>
          <span class="relative inline-flex items-center group">
            <span class="inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-gray-600 bg-gray-200 rounded-full">?</span>
            <span class="absolute left-1/2 top-full mt-2 w-72 -translate-x-1/2 rounded bg-gray-900 text-white text-xs px-3 py-2 opacity-0 group-hover:opacity-100 transition pointer-events-none">
              å°ã•ã„ã»ã©ç´°ã‹ããƒˆãƒ¬ãƒ¼ã‚¹ã•ã‚Œã¾ã™ï¼ˆltresï¼‰ã€‚
            </span>
          </span>
        </label>
        <input id="ltres" type="number" min="0.1" max="10" step="0.1" value="1" class="border border-gray-300 rounded w-full p-2" />
      </div>
      <div>
        <label class="flex flex-wrap items-center gap-2 mb-2 font-semibold">
          <span>æ›²ç·šã®ç²¾åº¦</span>
          <span class="relative inline-flex items-center group">
            <span class="inline-flex items-center justify-center w-5 h-5 text-xs font-bold text-gray-600 bg-gray-200 rounded-full">?</span>
            <span class="absolute left-1/2 top-full mt-2 w-72 -translate-x-1/2 rounded bg-gray-900 text-white text-xs px-3 py-2 opacity-0 group-hover:opacity-100 transition pointer-events-none">
              å°ã•ã„ã»ã©æ»‘ã‚‰ã‹ã«è¿‘ã„æ›²ç·šã«ãªã‚Šã¾ã™ï¼ˆqtresï¼‰ã€‚
            </span>
          </span>
        </label>
        <input id="qtres" type="number" min="0.1" max="10" step="0.1" value="1" class="border border-gray-300 rounded w-full p-2" />
      </div>
    </div>

    <div class="flex flex-wrap gap-2 mb-6">
      <button id="convert" disabled class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-4 rounded disabled:bg-gray-300 disabled:text-gray-600 disabled:cursor-not-allowed">
        SVGåŒ–ã™ã‚‹
      </button>
    </div>

    <div class="mb-2 font-semibold">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</div>
    <div id="preview" class="border border-gray-200 rounded bg-gray-50 p-3 h-72 overflow-hidden"></div>

    <div class="flex flex-wrap gap-2 mt-4">
      <button id="download" disabled class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded disabled:bg-gray-300 disabled:text-gray-600 disabled:cursor-not-allowed">
        SVGã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      </button>
    </div>
  </div>

  <div id="loading" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
    <div class="bg-white px-6 py-4 rounded-lg shadow-lg text-gray-800">å‡¦ç†ä¸­â€¦</div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/imagetracerjs@1.2.6/imagetracer_v1.2.6.js"></script>

  <script>
    const fileInput = document.getElementById("file");
    const convertBtn = document.getElementById("convert");
    const btn = document.getElementById("download");
    const preview = document.getElementById("preview");
    const loading = document.getElementById("loading");
    const colorsInput = document.getElementById("colors");
    const ltresInput = document.getElementById("ltres");
    const qtresInput = document.getElementById("qtres");
    const presetSelect = document.getElementById("preset");

    let selectedFile = null;
    let lastSvgText = "";

    const presetMap = {
      standard: { numberofcolors: 8, ltres: 1, qtres: 1 },
      crisp: { numberofcolors: 6, ltres: 0.5, qtres: 1.2 },
      smooth: { numberofcolors: 6, ltres: 1.5, qtres: 0.5 },
      detail: { numberofcolors: 16, ltres: 0.8, qtres: 0.8 },
    };

    presetSelect.addEventListener("change", () => {
      applyPreset(presetSelect.value);
    });

    applyPreset(presetSelect.value);

    fileInput.addEventListener("change", () => {
      selectedFile = fileInput.files && fileInput.files[0];
      convertBtn.disabled = !selectedFile;
      btn.disabled = true;
      lastSvgText = "";
      preview.innerHTML = "";
    });

    convertBtn.addEventListener("click", async () => {
      if (!selectedFile) return;

      showLoading(true);
      btn.disabled = true;
      convertBtn.disabled = true;
      lastSvgText = "";
      preview.innerHTML = "";

      try {
        await nextFrame();

        if (!window.ImageTracer) {
          throw new Error("ImageTracer not loaded.");
        }

        const img = await fileToImage(selectedFile);
        const canvas = document.createElement("canvas");
        canvas.width = img.naturalWidth;
        canvas.height = img.naturalHeight;
        const ctx = canvas.getContext("2d", { willReadFrequently: true });
        ctx.drawImage(img, 0, 0);

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const options = readOptions();
        lastSvgText = window.ImageTracer.imagedataToSVG(imageData, options);

        preview.innerHTML = preparePreviewSvg(lastSvgText);
        btn.disabled = false;
      } catch (e) {
        console.error(e);
        alert("å¤‰æ›ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼‰");
      } finally {
        showLoading(false);
        convertBtn.disabled = !selectedFile;
      }
    });

    btn.addEventListener("click", () => {
      if (!lastSvgText) return;
      downloadText(lastSvgText, "output.svg", "image/svg+xml");
    });

    function showLoading(on) {
      loading.classList.toggle("hidden", !on);
      loading.classList.toggle("flex", on);
    }

    function nextFrame() {
      return new Promise(requestAnimationFrame);
    }

    function fileToImage(file) {
      return new Promise((resolve, reject) => {
        const url = URL.createObjectURL(file);
        const img = new Image();
        img.onload = () => {
          URL.revokeObjectURL(url);
          resolve(img);
        };
        img.onerror = reject;
        img.src = url;
      });
    }

    function downloadText(text, filename, mime) {
      const blob = new Blob([text], { type: mime });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function readOptions() {
      return {
        numberofcolors: readNumber(colorsInput, 8, 2, 64),
        ltres: readNumber(ltresInput, 1, 0.1, 10),
        qtres: readNumber(qtresInput, 1, 0.1, 10),
      };
    }

    function readNumber(input, fallback, min, max) {
      const value = Number.parseFloat(input.value);
      if (Number.isNaN(value)) return fallback;
      if (value < min) return min;
      if (value > max) return max;
      return value;
    }

    function applyPreset(key) {
      const preset = presetMap[key] || presetMap.standard;
      colorsInput.value = preset.numberofcolors;
      ltresInput.value = preset.ltres;
      qtresInput.value = preset.qtres;
    }

    function preparePreviewSvg(svgText) {
      const parser = new DOMParser();
      const doc = parser.parseFromString(svgText, "image/svg+xml");
      const svg = doc.querySelector("svg");
      if (!svg) return svgText;

      const widthAttr = svg.getAttribute("width");
      const heightAttr = svg.getAttribute("height");
      const hasViewBox = svg.hasAttribute("viewBox");
      const width = widthAttr ? Number.parseFloat(widthAttr) : null;
      const height = heightAttr ? Number.parseFloat(heightAttr) : null;

      if (!hasViewBox && width && height) {
        svg.setAttribute("viewBox", `0 0 ${width} ${height}`);
      }
      svg.setAttribute("width", "100%");
      svg.setAttribute("height", "100%");
      if (!svg.hasAttribute("preserveAspectRatio")) {
        svg.setAttribute("preserveAspectRatio", "xMidYMid meet");
      }

      return new XMLSerializer().serializeToString(svg);
    }

    function toggleMenu() {
      const panel = document.getElementById("menuPanel");
      if (!panel) return;
      panel.classList.toggle("hidden");
    }
  </script>
</body>
</html>
